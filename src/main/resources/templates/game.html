<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo - Quem Quer Ser Milionário?</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/game.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
</head>
<body class="game-page">
    <div class="particles-background"></div>
    
    <div class="game-container">
        <!-- Header -->
        <header class="game-header">
            <h1 class="logo-title-small">QUEM QUER SER MILIONÁRIO?</h1>
        </header>
        
        <div class="game-content">
            <!-- Pirâmide de Prêmios -->
            <div class="prize-pyramid">
                <div th:each="prize, iterStat : ${prizeTable}" 
                     class="prize-level">
                    <span class="prize-value" th:text="${'R$ ' + #numbers.formatDecimal(prize, 0, 'POINT', 0, 'POINT')}">R$ 1.000</span>
                </div>
            </div>
            
            <!-- Área Central -->
            <div class="question-area">
                <!-- Timer -->
                <div class="timer-container">
                    <div id="timer" class="timer-circle">30</div>
                </div>
                
                <!-- Pergunta -->
                <div class="question-card" th:if="${question}">
                    <div class="question-header">
                        <span class="question-number" th:text="${'PERGUNTA ' + (currentLevel != null ? currentLevel : (session.currentLevel != null ? session.currentLevel : 1)) + ' DE 15'}">PERGUNTA 1 DE 15</span>
                        <span class="question-category" th:if="${question.category}" th:text="${'CATEGORIA: ' + question.category}">CATEGORIA: História</span>
                    </div>
                    <div class="question-text" th:text="${question.questionText}">
                        Qual é a capital do Brasil?
                    </div>
                </div>
                
                <!-- Alternativas -->
                <div class="alternatives-grid" id="alternativesGrid">
                    <div class="alternative-card" 
                         data-option="A"
                         onclick="selectAlternative('A')"
                         th:if="${question}">
                        <span class="alternative-letter">A</span>
                        <span class="alternative-text" th:text="${question.optionA}">São Paulo</span>
                    </div>
                    <div class="alternative-card" 
                         data-option="B"
                         onclick="selectAlternative('B')"
                         th:if="${question}">
                        <span class="alternative-letter">B</span>
                        <span class="alternative-text" th:text="${question.optionB}">Rio de Janeiro</span>
                    </div>
                    <div class="alternative-card" 
                         data-option="C"
                         onclick="selectAlternative('C')"
                         th:if="${question}">
                        <span class="alternative-letter">C</span>
                        <span class="alternative-text" th:text="${question.optionC}">Brasília</span>
                    </div>
                    <div class="alternative-card" 
                         data-option="D"
                         onclick="selectAlternative('D')"
                         th:if="${question}">
                        <span class="alternative-letter">D</span>
                        <span class="alternative-text" th:text="${question.optionD}">Salvador</span>
                    </div>
                </div>
                
                <!-- Coringas -->
                <div class="lifelines-container">
                    <button class="lifeline-btn" 
                            id="skipBtn"
                            th:disabled="${session != null && session.skipsLeft != null && session.skipsLeft == 0}"
                            onclick="useSkip()">
                        <span>PULAR</span>
                        <small class="lifeline-count" th:text="${(skipsLeft != null ? skipsLeft : (session.skipsLeft != null ? session.skipsLeft : 3)) + ' restantes'}">3 restantes</small>
                    </button>
                    <button class="lifeline-btn" 
                            id="fiftyFiftyBtn"
                            th:disabled="${session != null && session.fiftyFiftyUsed == true}"
                            th:attr="data-fifty-fifty-used=${session != null ? session.fiftyFiftyUsed : false}"
                            onclick="useFiftyFifty()">
                        <span>50:50</span>
                    </button>
                    <button class="lifeline-btn" 
                            id="aiHelpBtn"
                            th:disabled="${session.aiHelpUsed}"
                            onclick="useAiHelp()">
                        <span>AJUDA DA IA</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Ajuda da IA -->
    <div id="aiHelpModal" class="modal-overlay" style="display: none;">
        <div class="modal-content ai-modal">
            <h2 class="mb-3">Ajuda da IA</h2>
            <div id="aiLoading" class="text-center">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3">A IA está analisando...</p>
            </div>
            <div id="aiResponse" style="display: none;">
                <div class="ai-suggestion">
                    <div class="ai-letter" id="aiLetter">A</div>
                    <div class="ai-answer" id="aiAnswer">Resposta sugerida</div>
                </div>
                <div class="confidence-bar-container">
                    <label>Confiança: <span id="aiConfidence">0</span>%</label>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill"></div>
                    </div>
                </div>
                <p class="ai-explanation" id="aiExplanation">Explicação...</p>
                <button class="btn btn-gold btn-lg w-100 mt-3" onclick="closeAiModal()">OK, ENTENDI</button>
            </div>
            <div id="aiError" style="display: none;">
                <div class="text-center mb-4">
                    <div class="ai-letter" style="background-color: #ffc107; color: #000; font-size: 4rem; width: 120px; height: 120px; margin: 0 auto; display: flex; align-items: center; justify-content: center; border-radius: 50%;">?</div>
                    <h3 class="text-warning mt-3">NÃO DISPONÍVEL</h3>
                </div>
                <div class="confidence-bar-container mb-3">
                    <label>Confiança: <span>0</span>%</label>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <p class="text-white text-center" id="aiErrorMessage">A IA está temporariamente indisponível. Confie no seu conhecimento!</p>
                <button class="btn btn-gold btn-lg w-100 mt-3" onclick="closeAiModal()">OK, ENTENDI</button>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        const questionId = /*[[${question != null ? question.id : null}]]*/ null;
        const sessionId = /*[[${session != null && session.id != null ? session.id : null}]]*/ null;
        // Forçar o valor do currentLevel do servidor - usar o atributo explícito primeiro
        let currentLevel = /*[[${currentLevel != null ? currentLevel : (session != null ? session.currentLevel : 1)}]]*/ 1;
        let skipsLeft = /*[[${skipsLeft != null ? skipsLeft : (session != null ? session.skipsLeft : 3)}]]*/ 3;
        
        console.log('=== VALORES DO SERVIDOR ===');
        console.log('Current Level do servidor (atributo explícito):', /*[[${currentLevel}]]*/ null);
        console.log('Current Level do servidor (da sessão):', /*[[${session != null ? session.currentLevel : null}]]*/ null);
        console.log('Current Level JavaScript:', currentLevel);
        console.log('Skips Left do servidor:', skipsLeft);
        console.log('Session ID:', sessionId);
        console.log('Question ID:', questionId);
        let timeLeft = 30;
        let timerInterval;
        let questionStartTime = Date.now();
        let selectedAnswer = null;
        let answerSubmitted = false;
        
        console.log('Question ID:', questionId);
        console.log('Session ID:', sessionId);
        console.log('Current Level:', currentLevel);
        
        // Atualizar classes da pirâmide de prêmios
        function updatePrizePyramid() {
            const prizeLevels = document.querySelectorAll('.prize-level');
            const totalLevels = prizeLevels.length; // 15 níveis
            
            console.log('=== ATUALIZANDO PIRÂMIDE ===');
            console.log('Current Level:', currentLevel);
            console.log('Total Levels:', totalLevels);
            
            if (!currentLevel || currentLevel < 1 || currentLevel > 15) {
                console.error('ERRO: currentLevel inválido:', currentLevel);
                return;
            }
            
            prizeLevels.forEach((level, index) => {
                // Agora o array já está invertido, então índice 0 = nível 15 (topo), índice 14 = nível 1 (base)
                const levelNumber = totalLevels - index; // Inverter o índice
                
                // Remover classes anteriores
                level.classList.remove('current-level', 'conquered', 'safe-stop');
                
                // Adicionar classe para nível atual (amarelo/dourado)
                if (levelNumber === currentLevel) {
                    level.classList.add('current-level');
                    console.log('✓ Nível ATUAL (amarelo):', levelNumber, 'no índice:', index);
                }
                // Adicionar classe para níveis conquistados (verde)
                if (levelNumber < currentLevel) {
                    level.classList.add('conquered');
                    console.log('  Nível conquistado (verde):', levelNumber);
                }
                // Adicionar classe para paradas seguras (níveis 5 e 10)
                if (levelNumber === 5 || levelNumber === 10) {
                    level.classList.add('safe-stop');
                }
            });
            console.log('=== PIRÂMIDE ATUALIZADA ===');
        }
        
        function startTimer() {
            timeLeft = 30;
            updateTimerDisplay();
            questionStartTime = Date.now();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 10) {
                    document.getElementById('timer').classList.add('urgent');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer');
            timerElement.textContent = timeLeft;
            const percentage = (timeLeft / 30) * 100;
            timerElement.style.setProperty('--timer-percentage', percentage + '%');
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
        }
        
        function handleTimeout() {
            console.log('=== TIMEOUT TRIGGERED ===');
            console.log('answerSubmitted:', answerSubmitted);
            console.log('questionId:', questionId);
            
            if (answerSubmitted) {
                console.log('Answer already submitted, ignoring timeout');
                return;
            }
            
            // Parar o timer imediatamente
            stopTimer();
            answerSubmitted = true;
            
            // Desabilitar todas as alternativas
            document.querySelectorAll('.alternative-card').forEach(card => {
                card.style.pointerEvents = 'none';
            });
            
            // Mostrar mensagem de timeout
            alert('Tempo esgotado! Você perdeu.');
            
            if (!questionId) {
                console.error('Question ID is null on timeout!');
                window.location.href = '/game/gameover';
                return;
            }
            
            console.log('Timeout! Submitting answer...');
            
            // Calcular tempo gasto (30 segundos para timeout)
            const timeSpent = 30;
            
            // Enviar uma resposta errada para finalizar o jogo
            fetch('/game/answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `questionId=${questionId}&answer=A&timeSpent=${timeSpent}`
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao processar timeout');
                }
                return response.json();
            })
            .then(data => {
                console.log('Timeout processado:', data);
                // Sempre redirecionar para gameover após timeout
                window.location.href = '/game/gameover';
            })
            .catch(error => {
                console.error('Erro ao processar timeout:', error);
                // Mesmo com erro, redirecionar para gameover
                window.location.href = '/game/gameover';
            });
        }
        
        function selectAlternative(option) {
            console.log('selectAlternative called with:', option);
            if (answerSubmitted) {
                console.log('Answer already submitted');
                return;
            }
            if (!questionId) {
                console.error('Question ID is null!');
                alert('Erro: ID da pergunta não encontrado. Recarregue a página.');
                return;
            }
            selectedAnswer = option;
            
            // Remover seleção anterior
            document.querySelectorAll('.alternative-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Marcar como selecionada
            document.querySelector(`[data-option="${option}"]`).classList.add('selected');
            
            // Desabilitar todas
            document.querySelectorAll('.alternative-card').forEach(card => {
                card.style.pointerEvents = 'none';
            });
            
            stopTimer();
            submitAnswer(option);
        }
        
        function submitAnswer(answer) {
            if (answerSubmitted) return;
            answerSubmitted = true;
            
            const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
            
            // Se for timeout, usar tempo máximo e resposta errada
            const finalTimeSpent = (answer === 'X') ? 30 : timeSpent;
            // Para timeout, enviar uma resposta que certamente está errada
            // Vamos enviar 'A' que será tratado como resposta normal (mas provavelmente estará errada)
            const finalAnswer = (answer === 'X') ? 'A' : answer;
            
            fetch('/game/answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `questionId=${questionId}&answer=${finalAnswer}&timeSpent=${finalTimeSpent}`
            })
            .then(response => {
                if (!response.ok) {
                    // Tentar ler a mensagem de erro do JSON
                    return response.json().then(data => {
                        const errorMsg = data.error || 'Erro na resposta do servidor (status: ' + response.status + ')';
                        console.error('Erro HTTP:', response.status, errorMsg);
                        throw new Error(errorMsg);
                    }).catch(() => {
                        throw new Error('Erro na resposta do servidor (status: ' + response.status + ')');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Resposta recebida:', data);
                
                if (data.error) {
                    console.error('Erro do servidor:', data.error);
                    alert('Erro: ' + data.error);
                    // Em caso de erro, redirecionar para gameover apenas se for um erro fatal
                    if (data.error.includes('Sessão não encontrada') || data.error.includes('Pergunta não encontrada')) {
                        setTimeout(() => {
                            window.location.href = '/game/gameover';
                        }, 2000);
                    }
                    return;
                }
                
                // Verificar se a resposta está correta
                if (data.correct === true || data.correct === 'true') {
                    console.log('=== RESPOSTA CORRETA ===');
                    console.log('Dados recebidos:', data);
                    handleCorrectAnswer(answer === 'X' ? null : answer);
                    // Atualizar currentLevel com o valor do servidor
                    if (data.currentLevel) {
                        console.log('Atualizando currentLevel:', currentLevel, '->', data.currentLevel);
                        currentLevel = data.currentLevel;
                        updatePrizePyramid();
                    } else {
                        // Se não veio no response, incrementar manualmente
                        currentLevel = currentLevel + 1;
                        console.log('Incrementando currentLevel manualmente:', currentLevel);
                        updatePrizePyramid();
                    }
                    if (data.won === true || data.won === 'true') {
                        console.log('JOGADOR GANHOU! Redirecionando para winner...');
                        setTimeout(() => {
                            window.location.href = data.redirectUrl || '/game/winner';
                        }, 2000);
                    } else {
                        console.log('Resposta correta, mas ainda não ganhou. Redirecionando para próxima pergunta...');
                        setTimeout(() => {
                            window.location.href = '/game';
                        }, 2000);
                    }
                } else {
                    // Para timeout, mostrar que o tempo acabou
                    if (answer === 'X') {
                        alert('Tempo esgotado! Você perdeu.');
                    }
                    console.log('Resposta errada. Prêmio final:', data.finalPrize);
                    handleWrongAnswer(answer === 'X' ? null : answer, data.correctAnswer);
                    // Passar o score final como parâmetro na URL
                    const finalPrize = data.finalPrize || 0;
                    setTimeout(() => {
                        window.location.href = (data.redirectUrl || '/game/gameover') + '?prize=' + finalPrize;
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Erro ao processar resposta:', error);
                console.error('Stack trace:', error.stack);
                // Tentar obter mais detalhes do erro
                if (error.message) {
                    console.error('Mensagem de erro:', error.message);
                }
                alert('Erro ao processar resposta: ' + (error.message || 'Erro desconhecido') + '. Verifique o console para mais detalhes.');
                // Não redirecionar automaticamente, deixar o usuário tentar novamente
            });
        }
        
        function handleCorrectAnswer(selected) {
            if (selected) {
                const card = document.querySelector(`[data-option="${selected}"]`);
                if (card) {
                    card.classList.add('correct');
                    setTimeout(() => {
                        card.classList.add('flash-green');
                    }, 100);
                }
            }
        }
        
        function handleWrongAnswer(selected, correct) {
            if (selected && selected !== 'X') {
                const selectedCard = document.querySelector(`[data-option="${selected}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('wrong');
                }
            }
            if (correct) {
                const correctCard = document.querySelector(`[data-option="${correct}"]`);
                if (correctCard) {
                    correctCard.classList.add('correct');
                }
            }
        }
        
        function useSkip() {
            if (answerSubmitted) return;
            
            console.log('=== USANDO PULAR ===');
            console.log('Skips antes:', skipsLeft);
            
            fetch('/game/skip', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Resposta do skip:', data);
                if (data.success) {
                    // Recarregar a página para atualizar todos os valores
                    location.reload();
                } else {
                    alert(data.error || 'Erro ao usar pulo');
                }
            })
            .catch(error => {
                console.error('Erro ao usar pulo:', error);
                alert('Erro ao usar pulo');
            });
        }
        
        function useFiftyFifty() {
            const fiftyFiftyBtn = document.getElementById('fiftyFiftyBtn');
            if (fiftyFiftyBtn && (fiftyFiftyBtn.disabled || fiftyFiftyBtn.hasAttribute('disabled'))) {
                console.log('useFiftyFifty - Botão já está desabilitado, ignorando...');
                return;
            }
            if (answerSubmitted) return;
            
            const btn = document.getElementById('fiftyFiftyBtn');
            if (btn.disabled) {
                return;
            }
            
            fetch('/game/fifty-fifty?questionId=' + questionId, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.removedOptions.forEach(option => {
                        const card = document.querySelector(`[data-option="${option}"]`);
                        card.classList.add('removed');
                        card.style.pointerEvents = 'none';
                    });
                    // Desabilitar o botão permanentemente
                    btn.disabled = true;
                    btn.setAttribute('disabled', 'disabled');
                    btn.setAttribute('data-fifty-fifty-used', 'true');
                    applyDisabledStyle(btn);
                    console.log('Botão 50:50 desabilitado após uso e estilizado');
                } else {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Erro ao usar 50:50:', error);
                alert('Erro ao usar 50:50');
            });
        }
        
        function useAiHelp() {
            if (answerSubmitted) return;
            
            // Verificar se o botão está desabilitado (já foi usado)
            const aiHelpBtn = document.getElementById('aiHelpBtn');
            if (aiHelpBtn && (aiHelpBtn.disabled || aiHelpBtn.hasAttribute('disabled'))) {
                // Mostrar alerta e não abrir o modal
                alert('⚠️ Você já utilizou a ajuda da IA nesta partida!\n\nEsta ajuda só pode ser usada uma vez por partida.');
                return;
            }
            
            document.getElementById('aiHelpModal').style.display = 'flex';
            document.getElementById('aiLoading').style.display = 'block';
            document.getElementById('aiResponse').style.display = 'none';
            document.getElementById('aiError').style.display = 'none';
            
            // Mínimo de 2 segundos para dramaticidade
            const minDelay = 2000;
            const startTime = Date.now();
            
            fetch('/game/ai-help?questionId=' + questionId, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro HTTP: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const elapsed = Date.now() - startTime;
                const remainingDelay = Math.max(0, minDelay - elapsed);
                
                setTimeout(() => {
                    document.getElementById('aiLoading').style.display = 'none';
                    
                    // Verificar se já foi usado
                    if (data.alreadyUsed) {
                        const errorMsg = data.message || 'Você já utilizou a ajuda da IA nesta partida. Esta ajuda só pode ser usada uma vez!';
                        document.getElementById('aiErrorMessage').textContent = errorMsg;
                        document.getElementById('aiError').style.display = 'block';
                        // Desabilitar o botão no frontend também
                        if (aiHelpBtn) {
                            disableAiHelpButton(aiHelpBtn);
                        }
                        return;
                    }
                    
                    if (data.success && data.aiResponse) {
                        // Verificar se é uma resposta válida (não é fallback)
                        if (data.aiResponse.letter && data.aiResponse.letter !== '?' && data.aiResponse.confidence > 0) {
                            document.getElementById('aiLetter').textContent = data.aiResponse.letter;
                            document.getElementById('aiAnswer').textContent = data.aiResponse.answer;
                            document.getElementById('aiConfidence').textContent = data.aiResponse.confidence;
                            document.getElementById('aiExplanation').textContent = data.aiResponse.explanation;
                            
                            const confidenceFill = document.getElementById('confidenceFill');
                            confidenceFill.style.width = data.aiResponse.confidence + '%';
                            
                            document.getElementById('aiResponse').style.display = 'block';
                            
                            // Desabilitar o botão após usar com sucesso
                            if (aiHelpBtn) {
                                disableAiHelpButton(aiHelpBtn);
                            }
                        } else {
                            // Resposta de fallback ou erro
                            const errorMsg = data.message || data.aiResponse?.explanation || 'A IA está temporariamente indisponível. Confie no seu conhecimento!';
                            document.getElementById('aiErrorMessage').textContent = errorMsg;
                            document.getElementById('aiError').style.display = 'block';
                        }
                    } else {
                        // Erro retornado pelo servidor
                        const errorMsg = data.message || 'A IA está temporariamente indisponível. Confie no seu conhecimento!';
                        document.getElementById('aiErrorMessage').textContent = errorMsg;
                        document.getElementById('aiError').style.display = 'block';
                    }
                }, remainingDelay);
            })
            .catch(error => {
                console.error('Erro ao chamar IA:', error);
                document.getElementById('aiLoading').style.display = 'none';
                document.getElementById('aiErrorMessage').textContent = 'Erro ao conectar com a IA. Tente novamente mais tarde.';
                document.getElementById('aiError').style.display = 'block';
            });
        }
        
        function closeAiModal() {
            document.getElementById('aiHelpModal').style.display = 'none';
        }
        
        // Iniciar timer quando a página carregar
        // Função para aplicar estilo cinza aos botões desabilitados
        function applyDisabledStyle(btn) {
            if (!btn) {
                console.error('applyDisabledStyle: botão é null!');
                return;
            }
            console.log('applyDisabledStyle: aplicando estilo cinza ao botão', btn.id);
            btn.disabled = true;
            btn.setAttribute('disabled', 'disabled');
            btn.setAttribute('data-fifty-fifty-used', 'true');
            // Forçar estilo cinza via JavaScript - usar setProperty com important
            btn.style.setProperty('background', 'linear-gradient(135deg, #666666 0%, #444444 100%)', 'important');
            btn.style.setProperty('background-color', '#666666', 'important');
            btn.style.setProperty('color', '#999999', 'important');
            btn.style.setProperty('opacity', '0.7', 'important');
            btn.style.setProperty('filter', 'grayscale(100%)', 'important');
            btn.style.setProperty('cursor', 'not-allowed', 'important');
            btn.style.setProperty('box-shadow', 'none', 'important');
            btn.style.setProperty('pointer-events', 'none', 'important');
            // Adicionar classe também
            btn.classList.add('disabled');
            console.log('applyDisabledStyle: estilo aplicado. Background:', btn.style.background);
        }
        
        // Função específica para desabilitar o botão de ajuda da IA
        function disableAiHelpButton(btn) {
            if (!btn) {
                console.error('disableAiHelpButton: botão é null!');
                return;
            }
            console.log('disableAiHelpButton: desabilitando botão de IA');
            btn.disabled = true;
            btn.setAttribute('disabled', 'disabled');
            btn.setAttribute('data-ai-help-used', 'true');
            
            // Aplicar estilos visuais
            btn.style.setProperty('background', 'linear-gradient(135deg, #666666 0%, #444444 100%)', 'important');
            btn.style.setProperty('background-color', '#666666', 'important');
            btn.style.setProperty('color', '#999999', 'important');
            btn.style.setProperty('opacity', '0.7', 'important');
            btn.style.setProperty('filter', 'grayscale(100%)', 'important');
            btn.style.setProperty('cursor', 'not-allowed', 'important');
            btn.style.setProperty('box-shadow', 'none', 'important');
            btn.style.setProperty('pointer-events', 'none', 'important');
            btn.style.setProperty('user-select', 'none', 'important');
            btn.classList.add('disabled');
            
            // Substituir o onclick para mostrar alerta
            btn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                alert('⚠️ Você já utilizou a ajuda da IA nesta partida!\n\nEsta ajuda só pode ser usada uma vez por partida.');
                return false;
            };
            
            console.log('disableAiHelpButton: botão desabilitado com sucesso');
        }
        
        // Executar assim que o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== DOM CARREGADO ===');
            // Aplicar estilo aos botões desabilitados imediatamente
            const fiftyFiftyBtn = document.getElementById('fiftyFiftyBtn');
            if (fiftyFiftyBtn) {
                const dataUsed = fiftyFiftyBtn.getAttribute('data-fifty-fifty-used');
                const isDataUsed = dataUsed === 'true' || dataUsed === true || dataUsed === 'True' || 
                                   (dataUsed !== null && dataUsed !== 'false' && dataUsed !== false && dataUsed !== 'False');
                console.log('DOMContentLoaded - Botão 50:50 - disabled:', fiftyFiftyBtn.disabled, 'data-fifty-fifty-used:', dataUsed, 'isDataUsed:', isDataUsed);
                // Se o atributo data diz que foi usado, ou se está desabilitado, aplicar estilo
                if (isDataUsed || fiftyFiftyBtn.disabled || fiftyFiftyBtn.hasAttribute('disabled')) {
                    console.log('DOMContentLoaded - Aplicando estilo cinza ao 50:50');
                    applyDisabledStyle(fiftyFiftyBtn);
                    // Garantir que o atributo disabled também seja setado
                    fiftyFiftyBtn.disabled = true;
                    fiftyFiftyBtn.setAttribute('disabled', 'disabled');
                }
            }
            const aiHelpBtn = document.getElementById('aiHelpBtn');
            if (aiHelpBtn) {
                const aiDataUsed = aiHelpBtn.getAttribute('data-ai-help-used');
                const isAiDataUsed = aiDataUsed === 'true' || aiDataUsed === true || aiDataUsed === 'True' || 
                                      (aiDataUsed !== null && aiDataUsed !== 'false' && aiDataUsed !== false && aiDataUsed !== 'False');
                if (isAiDataUsed || aiHelpBtn.disabled || aiHelpBtn.hasAttribute('disabled')) {
                    disableAiHelpButton(aiHelpBtn);
                }
            }
            updateLifelineButtons();
        });
        
        window.addEventListener('load', () => {
            console.log('=== PÁGINA CARREGADA ===');
            console.log('Current Level:', currentLevel);
            console.log('Skips Left:', skipsLeft);
            startTimer();
            // Atualizar pirâmide imediatamente
            updatePrizePyramid();
            // Atualizar estado dos botões de lifeline
            updateLifelineButtons();
            // Forçar atualização após um pequeno delay para garantir que o DOM está pronto
            setTimeout(() => {
                console.log('Atualizando pirâmide novamente após delay - currentLevel:', currentLevel);
                updatePrizePyramid();
                updateLifelineButtons();
            }, 100);
            // Forçar atualização novamente após mais um delay
            setTimeout(() => {
                updateLifelineButtons();
            }, 300);
            setTimeout(() => {
                updateLifelineButtons();
            }, 600);
        });
        
        // Função para atualizar o estado dos botões de lifeline
        function updateLifelineButtons() {
            // Atualizar botão PULAR
            const skipBtn = document.getElementById('skipBtn');
            if (skipBtn) {
                if (skipsLeft <= 0) {
                    skipBtn.disabled = true;
                    skipBtn.setAttribute('disabled', 'disabled');
                    skipBtn.style.pointerEvents = 'none';
                    skipBtn.classList.add('disabled');
                    // Forçar estilo cinza via JavaScript
                    skipBtn.style.background = 'linear-gradient(135deg, #666666 0%, #444444 100%)';
                    skipBtn.style.color = '#999999';
                    skipBtn.style.opacity = '0.7';
                    skipBtn.style.filter = 'grayscale(100%)';
                    skipBtn.style.cursor = 'not-allowed';
                    skipBtn.style.boxShadow = 'none';
                }
            }
            
            // Atualizar botão 50:50 - SEMPRE verificar e aplicar estilo se desabilitado
            const fiftyFiftyBtn = document.getElementById('fiftyFiftyBtn');
            if (fiftyFiftyBtn) {
                const dataUsed = fiftyFiftyBtn.getAttribute('data-fifty-fifty-used');
                // Verificar se dataUsed é 'true', true, 'True', ou qualquer valor truthy
                const isDataUsed = dataUsed === 'true' || dataUsed === true || dataUsed === 'True' || 
                                   (dataUsed !== null && dataUsed !== 'false' && dataUsed !== false && dataUsed !== 'False');
                const isDisabled = fiftyFiftyBtn.disabled || 
                                   fiftyFiftyBtn.hasAttribute('disabled') ||
                                   isDataUsed;
                
                console.log('updateLifelineButtons - Botão 50:50 - Disabled:', fiftyFiftyBtn.disabled, 'HasAttribute:', fiftyFiftyBtn.hasAttribute('disabled'), 'Data:', dataUsed, 'isDataUsed:', isDataUsed, 'isDisabled:', isDisabled);
                
                // SEMPRE aplicar estilo se o data diz que foi usado, mesmo que disabled seja false
                if (isDataUsed) {
                    console.log('Data-fifty-fifty-used indica que foi usado, FORÇANDO estilo cinza!');
                    applyDisabledStyle(fiftyFiftyBtn);
                    // Garantir que o atributo disabled também seja setado
                    fiftyFiftyBtn.disabled = true;
                    fiftyFiftyBtn.setAttribute('disabled', 'disabled');
                } else if (isDisabled) {
                    console.log('Botão está desabilitado, aplicando estilo cinza...');
                    applyDisabledStyle(fiftyFiftyBtn);
                }
            } else {
                console.error('updateLifelineButtons - Botão 50:50 NÃO encontrado!');
            }
            
            // Atualizar botão AI Help
            const aiHelpBtn = document.getElementById('aiHelpBtn');
            if (aiHelpBtn) {
                if (aiHelpBtn.disabled || aiHelpBtn.hasAttribute('disabled')) {
                    disableAiHelpButton(aiHelpBtn);
                }
            }
        }
    </script>
</body>
</html>

